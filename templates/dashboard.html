<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Careerra - AI Mock Interview</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #3b82f6, #2563eb);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
        }

        body {
            background: #0f172a;
            min-height: 100vh;
            font-family: "Segoe UI", sans-serif;
            color: var(--text-primary);
            overflow: hidden;
        }

        /* Layout */
        .wrapper {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: rgba(15, 23, 42, 0.95);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: width 0.3s ease;
            position: relative;
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar.collapsed .brand-logo span,
        .sidebar.collapsed .nav-link span,
        .sidebar.collapsed .sidebar-footer span {
            display: none;
        }

        .sidebar.collapsed .brand-logo {
            justify-content: center;
        }

        .sidebar.collapsed .nav-link {
            justify-content: center;
        }

        .sidebar.collapsed .nav-link i {
            margin-right: 0;
            font-size: 1.5rem;
        }

        .sidebar-toggle-btn {
            position: absolute;
            top: 50%;
            right: -12px;
            width: 24px;
            height: 24px;
            background: #3b82f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            border: 2px solid #0f172a;
            z-index: 1001;
            transform: translateY(-50%);
            transition: transform 0.3s;
        }

        .sidebar.collapsed .sidebar-toggle-btn {
            transform: translateY(-50%) rotate(180deg);
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--glass-border);
        }

        .brand-logo {
            font-size: 24px;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-links {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-item {
            list-style: none;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 24px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: 0.3s;
            font-weight: 500;
            border-left: 3px solid transparent;
        }

        .nav-link:hover,
        .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.05);
            border-left-color: #3b82f6;
        }

        .nav-link i {
            margin-right: 12px;
            font-size: 1.2rem;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid var(--glass-border);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            position: relative;
            background: #020617;
            display: flex;
            flex-direction: column;
        }

        /* Audio Interface */
        .audio-interface {
            flex: 1;
            position: relative;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
        }

        /* AI Avatar (Central Voice Assistant Look) */
        .ai-avatar-container {
            text-align: center;
            z-index: 2;
            transform: scale(1.2);
            /* Enhance visibility */
        }

        .ai-avatar-large {
            width: 150px;
            height: 150px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: white;
            margin: 0 auto 30px auto;
            box-shadow: 0 0 50px rgba(37, 99, 235, 0.3);
            position: relative;
            transition: transform 0.3s ease;
        }

        .pulse {
            animation: pulse-voice 2s infinite;
        }

        @keyframes pulse-voice {
            0% {
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7);
            }

            70% {
                box-shadow: 0 0 0 40px rgba(37, 99, 235, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
            }
        }

        /* Start Overlay */
        .start-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Control Bar (Floating) */
        .control-bar {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            height: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 40px;
            border-radius: 60px;
            backdrop-filter: blur(15px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 100;
        }

        .btn-start {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
            color: white !important;
            font-size: 1.2rem;
            padding: 16px 40px;
            border-radius: 50px;
            border: none;
            font-weight: 700;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            margin-top: 30px;
            cursor: pointer;
            z-index: 100;
            position: relative;
        }

        .btn-start:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.6);
            color: white !important;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .control-btn.active {
            background: white;
            color: #0f172a;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
        }

        .control-btn.danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .control-btn.danger:hover {
            background: #ef4444;
            color: white;
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        .status-badge {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(16, 185, 129, 0.2);
            /* Green for active */
            padding: 8px 16px;
            border-radius: 20px;
            color: #6ee7b7;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(16, 185, 129, 0.3);
            display: none;
            z-index: 10;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Captions (Floating) */
        .captions-area {
            margin-top: 40px;
            background: rgba(0, 0, 0, 0.6);
            padding: 20px 40px;
            border-radius: 20px;
            color: white;
            font-size: 1.3rem;
            text-align: center;
            max-width: 700px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
            position: absolute;
            bottom: 120px;
            /* Position above controls */
        }

        @keyframes wave {

            0%,
            100% {
                height: 10px;
                opacity: 0.5;
            }

            50% {
                height: 35px;
                opacity: 1;
            }
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .settings-modal {
            background: #1e293b;
            border: 1px solid var(--glass-border);
            padding: 30px;
            border-radius: 20px;
            width: 400px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .settings-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: white;
            font-family: monospace;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .btn-save {
            width: 100%;
            padding: 12px;
            background: var(--primary-gradient);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-save:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
    </style>
</head>

<body>
    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="settings-modal">
            <div class="settings-header">
                <div class="settings-title">API Configuration</div>
                <button class="close-modal" onclick="toggleSettingsModal()"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="form-group">
                <label class="form-label">OpenAI API Key</label>
                <input type="password" id="apiKeyInput" class="form-input" placeholder="sk-..." value="">
            </div>
            <button class="btn-save" onclick="saveApiKey()">Save Configuration</button>
        </div>
    </div>


    <div class="wrapper">
        <!-- Sidebar -->
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-toggle-btn" onclick="toggleSidebar()">
                <i class="bi bi-chevron-left"></i>
            </div>

            <div class="sidebar-header">
                <div class="brand-logo">
                    <i class="bi bi-robot"></i> <span>Careerra</span>
                </div>
            </div>

            <ul class="nav-links p-0 m-0">
                <li class="nav-item">
                    <a href="#" class="nav-link active">
                        <i class="bi bi-mic-fill"></i> <span>Mock Interview</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <i class="bi bi-person-badge-fill"></i> <span>My Profile</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <i class="bi bi-code-square"></i> <span>Coding Challenges</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <i class="bi bi-graph-up-arrow"></i> <span>Performance</span>
                    </a>
                </li>
            </ul>

            <div class="sidebar-footer">
                <a href="{% url 'logout' %}" class="nav-link text-danger">
                    <i class="bi bi-box-arrow-right"></i> <span>Logout</span>
                </a>
            </div>
        </nav>

        <!-- Main Content (Audio Focused) -->
        <main class="main-content">

            <div class="audio-interface">

                <!-- Status Badge -->
                <div class="status-badge" id="liveStatus" style="top: 30px; left: 30px; z-index: 10;">
                    <div class="live-dot"></div>
                    Audio Session Active
                </div>

                <!-- AI Avatar -->
                <div class="ai-avatar-container">
                    <div class="ai-avatar-large" id="aiAvatar">
                        <i class="bi bi-robot"></i>
                    </div>
                    <h2 class="text-white mb-2 fw-bold">AI Interviewer</h2>
                    <div id="aiStateText" class="text-white-50">Waiting to start...</div>

                    <!-- Waveform Animation -->
                    <div id="aiWaveform" class="d-none d-flex align-items-center justify-content-center gap-2 mt-4"
                        style="height: 40px;">
                        <div class="bg-white rounded-pill"
                            style="width: 6px; height: 15px; opacity: 0.5; animation: wave 1s infinite;"></div>
                        <div class="bg-white rounded-pill"
                            style="width: 6px; height: 25px; opacity: 0.7; animation: wave 1s infinite 0.1s;"></div>
                        <div class="bg-white rounded-pill"
                            style="width: 6px; height: 35px; opacity: 0.9; animation: wave 1s infinite 0.2s;"></div>
                        <div class="bg-white rounded-pill"
                            style="width: 6px; height: 25px; opacity: 0.7; animation: wave 1s infinite 0.3s;"></div>
                        <div class="bg-white rounded-pill"
                            style="width: 6px; height: 15px; opacity: 0.5; animation: wave 1s infinite 0.4s;"></div>
                    </div>
                </div>

                <!-- Captions -->
                <div class="captions-area" id="captions">
                    "Hello! I am Careerra. Could you tell me about yourself and your background in IT?"
                </div>

                <!-- Start Overlay -->
                <div class="start-overlay" id="startOverlay">
                    <div class="text-center">
                        <div class="mb-4 text-primary" style="font-size: 3rem;">
                            <i class="bi bi-mic"></i>
                        </div>
                        <h2 class="text-white mb-3">Audio Interview Session</h2>
                        <p class="text-white-50 mb-5" style="max-width: 400px;">
                            We need microphone access to conduct the interview. Ensure you are in a quiet room.
                        </p>
                        <button class="btn btn-start" onclick="startInterview()">
                            <i class="bi bi-mic-fill"></i> Start Speaking
                        </button>
                    </div>
                </div>

                <!-- Control Bar -->
                <div class="control-bar">
                    <button class="control-btn" id="btnMic" title="Toggle Microphone">
                        <i class="bi bi-mic-mute-fill"></i>
                    </button>
                    <button class="control-btn danger" onclick="location.reload()" title="End Interview">
                        <i class="bi bi-telephone-x-fill"></i>
                    </button>
                    <button class="control-btn" title="Settings" onclick="toggleSettingsModal()">
                        <i class="bi bi-gear-fill"></i>
                    </button>
                    <button class="control-btn" title="Type Answer" onclick="toggleKeyboardInput()">
                        <i class="bi bi-keyboard"></i>
                    </button>
                </div>

                <!-- Text Input Fallback -->
                <div id="textInputContainer" class="position-absolute start-50 translate-middle-x"
                    style="bottom: 120px; width: 60%; display: none; z-index: 200;">
                    <div class="input-group">
                        <input type="text" id="manualInput"
                            class="form-control form-control-lg bg-dark text-white border-secondary rounded-start-pill ps-4"
                            placeholder="Type your answer here..." onkeypress="handleEnter(event)">
                        <button class="btn btn-primary rounded-end-pill px-4" onclick="sendManualInput()">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </div>
                </div>

            </div>

        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let isInterviewActive = false;
        let recognition;
        let synthesis = window.speechSynthesis;
        let conversationHistory = [
            { role: "system", content: "You are Careerra, a professional and friendly AI tech interviewer. You are interviewing the user for a Software Engineering role. Keep your responses concise, encouraging, and focused on one question at a time. Start by asking them to introduce themselves." }
        ];

        // Initialize Speech Recognition
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false; // Stop after one sentence to process
            recognition.lang = 'en-US';
            recognition.interimResults = false;

            recognition.onstart = function () {
                document.getElementById('aiStateText').innerText = "Listening...";
                document.getElementById('aiAvatar').classList.add('pulse');
                document.getElementById('btnMic').classList.add('active');
            };

            recognition.onend = function () {
                document.getElementById('aiAvatar').classList.remove('pulse');
                document.getElementById('btnMic').classList.remove('active');
                // If the interview is still active and we aren't processing/speaking, restart listening?
                // For now, let's wait for the AI to finish speaking before listening again.
            };

            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript;
                console.log("User said:", transcript);

                // Show user input in captions momentarily? Or just process it.
                document.getElementById('captions').innerText = `You: "${transcript}"`;
                document.getElementById('captions').style.display = 'block';

                // Send to AI
                chatWithAI(transcript);
            };

            recognition.onerror = function (event) {
                console.error("Speech recognition error", event.error);
                let msg = "Error: " + event.error;
                if (event.error === 'network' || event.error === 'no-speech' || event.error === 'aborted') {
                    msg = "Connection issue used. Switching to text mode.";
                }

                document.getElementById('aiStateText').innerText = msg;
                toggleKeyboardInput(true); // Always show text input on error so user isn't stuck
            };
        } else {
            alert("Web Speech API is not supported. Please use Chrome.");
        }

        async function startInterview() {
            if (!recognition) return;

            // Hide Overlay
            document.getElementById('startOverlay').style.display = 'none';
            // Show Status
            document.getElementById('liveStatus').style.display = 'flex';
            document.getElementById('aiWaveform').classList.remove('d-none');
            document.getElementById('captions').style.display = 'block';

            isInterviewActive = true;

            // Start the conversation
            // First, let the AI introduce itself (using the initial prompt)
            // But actually, we need to trigger the first question. 
            // Let's manually trigger the first AI speech.
            const firstMessage = "Hello! I am Careerra. Could you tell me about yourself and your background in IT?";
            conversationHistory.push({ role: "assistant", content: firstMessage });
            updateCaptions(firstMessage);
            speakText(firstMessage);
        }

        async function chatWithAI(userText) {
            document.getElementById('aiStateText').innerText = "Thinking...";
            conversationHistory.push({ role: "user", content: userText });

            let apiKey = localStorage.getItem('openai_api_key');
            // Fallback if key is missing
            if (!apiKey || apiKey === 'null' || apiKey === 'undefined') {
                apiKey = "";
                localStorage.setItem('openai_api_key', apiKey);
            }

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: conversationHistory,
                        max_tokens: 150
                    })
                });

                if (!response.ok) {
                    const errDetail = await response.json();
                    throw new Error(`API Error ${response.status}: ${errDetail.error.message || response.statusText}`);
                }
                const data = await response.json();

                // if (data.error) {
                //     throw new Error(data.error.message);
                // }

                const aiResponse = data.choices[0].message.content;
                conversationHistory.push({ role: "assistant", content: aiResponse });

                // Speak response
                updateCaptions(aiResponse);
                speakText(aiResponse);

            } catch (error) {
                console.error("AI Error:", error);
                document.getElementById('aiStateText').innerText = "AI Connection Error: " + error.message;
                // Check for quota or key errors specifically to be helpful
                if (error.message.includes('429')) {
                    const billingUrl = "https://platform.openai.com/account/billing/overview";
                    document.getElementById('captions').innerHTML = `Quota exceeded. <a href="${billingUrl}" target="_blank" style="color: #60a5fa; text-decoration: underline;">Add credits here</a>. Switching to Simulated Mode...`;
                    setTimeout(() => simulateAIResponse(userText), 3000);
                } else if (error.message.includes('401')) {
                    updateCaptions("Error: Invalid API Key. Please check settings.");
                } else {
                    updateCaptions("Connection Error: " + error.message);
                }
            }
        }

        // Fallback for testing when API quota is empty
        function simulateAIResponse(userText) {
            const genericResponses = [
                "That's interesting. Can you tell me about a challenging project you've worked on?",
                "How do you handle tight deadlines and pressure?",
                "What is your greatest strength as a developer?",
                "Describe a time you had a conflict with a team member. How did you resolve it?",
                "What programming languages are you most proficient in?",
                "Where do you see yourself in five years?",
                "Do you have any experience with cloud technologies like AWS or Azure?"
            ];

            // Allow time for "Thinking"
            setTimeout(() => {
                const randomResponse = genericResponses[Math.floor(Math.random() * genericResponses.length)];
                conversationHistory.push({ role: "assistant", content: randomResponse });
                updateCaptions(randomResponse);
                speakText(randomResponse);
            }, 1000);
        }

        function speakText(text) {
            if (synthesis.speaking) synthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 1;

            utterance.onstart = function () {
                document.getElementById('aiStateText').innerText = "Speaking...";
                document.getElementById('aiWaveform').style.opacity = '1';
            };

            utterance.onend = function () {
                document.getElementById('aiStateText').innerText = "Waiting for you...";
                document.getElementById('aiWaveform').style.opacity = '0.5';

                // Automatically start listening again after AI finishes
                if (isInterviewActive && recognition) {
                    try {
                        recognition.start();
                    } catch (e) { console.log("Recognition already started"); }
                }
            };

            synthesis.speak(utterance);
        }

        function updateCaptions(text) {
            document.getElementById('captions').innerText = text;
        }

        // Manual Mic Toggle
        document.getElementById('btnMic').addEventListener('click', function () {
            if (this.classList.contains('active')) {
                recognition.stop();
            } else {
                try { recognition.start(); } catch (e) { }
            }
        });
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }
        // Manual Input Handlers
        function toggleKeyboardInput(forceShow = false) {
            const container = document.getElementById('textInputContainer');
            // Check if it's currently hidden (or forced to show)
            if (forceShow === true || container.style.display === 'none' || container.style.display === '') {
                container.style.display = 'block';
                document.getElementById('manualInput').focus();
                // Specific fix: stop recognition if we are typing to avoid conflict
                if (recognition) try { recognition.abort(); } catch (e) { }
            } else {
                container.style.display = 'none';
            }
        }

        function sendManualInput() {
            const input = document.getElementById('manualInput');
            const text = input.value.trim();
            if (text) {
                // Hide input after send
                document.getElementById('textInputContainer').style.display = 'none';
                input.value = '';

                // Show in captions
                document.getElementById('captions').innerText = `You: "${text}"`;
                document.getElementById('captions').style.display = 'block';

                // Send to AI
                chatWithAI(text);
            }
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendManualInput();
        }
    </script>

</body>

</html>
<!-- fix: trigger git update -->